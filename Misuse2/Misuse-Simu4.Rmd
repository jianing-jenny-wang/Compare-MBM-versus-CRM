---
title: "Thesis1-UseBenchmark_as_Sample"
author: "Jianing Wang"
date: "12/5/2021"
output: html_document
---

```{r setup, include=FALSE}
## Golbal setting for the entire Markdown
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, error = FALSE)
```

```{r}
library(ggplot2)
library(dplyr)
```

Setup fixed factors
```{r}
nsim = 1000
targetN = 5000
targetppl<- seq(1,targetN)

```

## Simulation set 4

### Goal
Try to mimic the process that you have a census (Benchmark with a certain trait) but you take it as a nominal sample, then apply it to CRM. What would happen?

### Illustration
One possible reason that could make this problematic is, because the sub-population you choose as the benchmark is always with a certain trait, which is not equally happening to each target subject. Thus the benchmark sample is not a random sample w.r.t entire target population.

We exemplify this by introducing a covariate X with two levels X = 0 or 1, given different values in X, the probability of being member of the benchmark is different. I.e. pB(X=1) != pB(X=0)

The problem may happen when a second sample fails to capture such heterogeneity in the benchmark.

More extreme case is, if, say, for X = 0, pB(X=0) = 0, whereas pB(X=1) > 0. That means, for people with X=0, they have zero probability of being labeled as benchmark members. This, firstly, violates the underlying assumption that CRM requires all subjects have non-zero probability of entering all samples. But does MBM care this if not all people have non-zero probability to be in the benchmark? Probably not, this is another thing we want to illustrate.

### What we need to setup
Step 1: We need to label X = 0 or 1 to target population (40% vs 60%); i.e. N(X=1) + N(X=0) = N, N(X=1) = N(X=0) for simplicity
Step 2: Given X = 0 or 1, set up pB(X=0) or pB(X=1), make them different
Step 3: Label benchmark members given Step 2 via binomial model. For MBM, These labeled people won't change across simulations unless pB changes.
Step 4: For CRM, both samples are random samples, we say sample 1 for CRM completely record all benchmark people without errors. Thus for sample 1, get all benchmark members.
Step 5: Give a p2, random sample a second sample
Step 6: 
For CRM, you ignore the heterogeneity in sample 1, or you do a stratified analysis which LP estimator won't work, only Chapman could run without errors.
For MBM, the benchmark ppl is not change across iterations, only sample 2 could change, both NB model and direct method are used.

```{r}
# Scenario 1 for CRM
p.X1.vec <- 0.6
pB.X0.vec <- 0 # I call pB here because this benchmark incorrectly used as a sample
pB.X1.vec <- c(0.05, 0.1, 0.3, 0.6)
p2.vec <- c(0.05, 0.1, 0.3, 0.6)
scenarios1 <- expand.grid(p2 = p2.vec, pB.X1 = pB.X1.vec, pB.X0 = pB.X0.vec, p.X1 = p.X1.vec)
scenarios1 <- scenarios1[, c("p.X1","pB.X1","pB.X0","p2")]

# Function to simulate CRM process
source("Simu4.Scenarios.Function.R")

# Run simulation, get summary statistics for CRM process
simu4.crm.1.Nhat <- crm.1.ls(simsize = nsim, pplsize = targetN, p.X1 = scenarios1$p.X1, pB.X0 = scenarios1$pB.X0, pB.X1 = scenarios1$pB.X1, p2 = scenarios1$p2)

write.csv(simu4.crm.1.Nhat, file = "Simu_Output/Simu4/ResultTb/simu4.crm.1.Nhat.csv", row.names = FALSE)

# Run simulation, get summary statistics for MBM process
simu4.mbm.1.Nhat <- mbm.1.ls(simsize = nsim, pplsize = targetN, p.X1 = scenarios1$p.X1, pB.X0 = scenarios1$pB.X0, pB.X1 = scenarios1$pB.X1, p2 = scenarios1$p2)

write.csv(simu4.mbm.1.Nhat, file = "Simu_Output/Simu4/ResultTb/simu4.mbm.1.Nhat.csv", row.names = FALSE)
```


Plots for each value of p1 (pB), compare the relative bias with LB95/UB95 areas between the framework of CRM and MBM

??? Why Unlinked MBM has problem at p=0.05??? ---01/05/2022

```{r}
# Plot 1 (fixed pB = 0 for X=0 and 0.1/0.3/0.6 for X=1)
# Compare CRM LP & Chapman & Stratified Analysis versus MBM NB & Direct
source("Simu4.Scenarios.Function.R")
simu4.plot.CRM.MBM.diff.Est(dt.crm = simu4.crm.1.Nhat, dt.mbm = simu4.mbm.1.Nhat, p1_pB = pB.X1.vec[1])
simu4.plot.CRM.MBM.diff.Est(dt.crm = simu4.crm.1.Nhat, dt.mbm = simu4.mbm.1.Nhat, p1_pB = pB.X1.vec[2])
simu4.plot.CRM.MBM.diff.Est(dt.crm = simu4.crm.1.Nhat, dt.mbm = simu4.mbm.1.Nhat, p1_pB = pB.X1.vec[3])
simu4.plot.CRM.MBM.diff.Est(dt.crm = simu4.crm.1.Nhat, dt.mbm = simu4.mbm.1.Nhat, p1_pB = pB.X1.vec[4])
```

