---
title: "Thesis1-UseSample_as_Benchmark"
author: "Jianing Wang"
date: "11/21/2021"
output: html_document
---

```{r setup, include=FALSE}
## Golbal setting for the entire Markdown
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, error = FALSE)
```

```{r}
library(ggplot2)
library(dplyr)
```

Setup fixed factors
```{r}
nsim = 1000
targetN = 5000
targetppl<- seq(1,targetN)
```

## Simulation set 3

### Goal
Try to mimic the process that the user has two random samples, which is ideal to use CRM, but end up using MBM, i.e. treat one sample as the benchmark(census).

### What need to setup
1. True Benchmark (census) population - pB to select a sub-population with a trait
2. Sample 1 for CRM and set this to be the one as Benchmark in MBM
3. Sample 2 for CRM and set this to be the one as sample for generating the multiplier (proportion)

#### Scenario 1 - Linked/Not linked samples and incompete Benchmark

1. Two samples are not linked in MBM; CRM assumes linkage
2. True Benchmark size is not known
3. Given a sample (sample1) incompletely capture Benchmark people (incorrectly missed some Benchmark) and in MBM setting, user wants to take it as the benchmark
4. Another sample (sample2) is random sample of entire population, in unlinked setting, it reflects the true multiplier; in linked setting, the observed overlap is rescaled.

In CRM, you just have two samples, sample1 and sample2, but sample 1 is heterogeneous, trait is the source of heterogeneity; Also could see as linked MBM, the overlap is automatically changed and adjusted

In MBM assuming no linkage: 
   (1) You take sample1 as Benchmark sample and take n1 as the Benchmark size, you take sample2 as source for getting multiplier, however, it gives you the correct multiplier (samples are unlinked so it could achieve, in practice, this need external information to get estimates of true prevalence of Benchmark and plug in to the multiplier).
   (2) You take sample1 as Benchmark sample and take n1 as the Benchmark size, you are aware of the incompleteness and know % of missing in the Benchmark, so you adjust for the multiplier by deflating the same amount of % post-sampling

Simulation setup:
Step 1: pB select sub-population from entire population (Underlying)
Step 2: p1 < pB, the selection is if(sub-population) then assign p = p1_sub to select, if(! sub-population) then 0% select, get sample 1 (data at hands)
Step 3: p2 choose a random sample out of entire population to get sample 2(data at hands)

Note:
1. Step 3 for p2 is equivalent to:
(Step 3: given a pre-defined p2, select from sample 1 with this p2
Step 4: given the same pre-defined p2, select from pool outside of sample 1 with this p2)
This has been checked by plotting

Scenario for CRM
```{r}
# True Benchmark prevalence
pB.vec <- c(0.05, 0.1, 0.3, 0.6) # 0.1, 0.3, 0.6
# Deflation factor to reflect incomplete sample of the benchmark
p1_sub.vec <- c(0.85, 0.9, 0.95) # seq(0.65, 0.95, by = 0.1)
# Random sample 2
p2.vec <- c(0.05, 0.1, 0.3, 0.6)
# Combine permutation of scenarios
scenarios1 <- expand.grid(p1_sub_vec = p1_sub.vec, p2_vec = p2.vec, pB_vec = pB.vec)
scenarios1 <- scenarios1[, c("pB_vec","p2_vec","p1_sub_vec")]
# Load functions
source("Simu3.Scenarios.Function.R")
# Run simulation, get summary statistics
Simu3.s1.Nhat <- s3.1.vary_p(simsize = nsim, pplsize = targetN, 
                     pB = scenarios1$pB_vec,  p1_sub = scenarios1$p1_sub_vec, p2 = scenarios1$p2_vec)

# Write into a file
write.csv(Simu3.s1.Nhat, file = "/Users/jianingwang/Documents/Boston U PhD/___My Dissertation___/Work2_IndirectEst/_ThesisWork1-TwoSampleMBMvsCRM/Work1-Simulation/Simulation Misuse/Simu_Output/Simu3/ResultTb/Simu3.1/Version-20220105/Simu3.s1.Nhat.csv", row.names = FALSE)
```

Plot given each possible p1 and p1_sub, the relative bias as p2 increase.
```{r}
# Load functions
source("Simu3.Scenarios.Function.R")
simu3.1.plot.CRM.MBM.diff.Est(dt.combo = Simu3.s1.Nhat, p1_pB.i = pB.vec[1], p1_sub.i = p1_sub.vec[1])
simu3.1.plot.CRM.MBM.diff.Est(dt.combo = Simu3.s1.Nhat, p1_pB.i = pB.vec[1], p1_sub.i = p1_sub.vec[2])
simu3.1.plot.CRM.MBM.diff.Est(dt.combo = Simu3.s1.Nhat, p1_pB.i = pB.vec[1], p1_sub.i = p1_sub.vec[3])
# simu3.1.plot.CRM.MBM.diff.Est(dt.combo = Simu3.s1.Nhat, p1_pB.i = pB.vec[1], p1_sub.i = p1_sub.vec[4])

simu3.1.plot.CRM.MBM.diff.Est(dt.combo = Simu3.s1.Nhat, p1_pB.i = pB.vec[2], p1_sub.i = p1_sub.vec[1])
simu3.1.plot.CRM.MBM.diff.Est(dt.combo = Simu3.s1.Nhat, p1_pB.i = pB.vec[2], p1_sub.i = p1_sub.vec[2])
simu3.1.plot.CRM.MBM.diff.Est(dt.combo = Simu3.s1.Nhat, p1_pB.i = pB.vec[2], p1_sub.i = p1_sub.vec[3])
# simu3.1.plot.CRM.MBM.diff.Est(dt.combo = Simu3.s1.Nhat, p1_pB.i = pB.vec[2], p1_sub.i = p1_sub.vec[4])

simu3.1.plot.CRM.MBM.diff.Est(dt.combo = Simu3.s1.Nhat, p1_pB.i = pB.vec[3], p1_sub.i = p1_sub.vec[1])
simu3.1.plot.CRM.MBM.diff.Est(dt.combo = Simu3.s1.Nhat, p1_pB.i = pB.vec[3], p1_sub.i = p1_sub.vec[2])
simu3.1.plot.CRM.MBM.diff.Est(dt.combo = Simu3.s1.Nhat, p1_pB.i = pB.vec[3], p1_sub.i = p1_sub.vec[3])
# simu3.1.plot.CRM.MBM.diff.Est(dt.combo = Simu3.s1.Nhat, p1_pB.i = pB.vec[3], p1_sub.i = p1_sub.vec[4])

simu3.1.plot.CRM.MBM.diff.Est(dt.combo = Simu3.s1.Nhat, p1_pB.i = pB.vec[4], p1_sub.i = p1_sub.vec[1])
simu3.1.plot.CRM.MBM.diff.Est(dt.combo = Simu3.s1.Nhat, p1_pB.i = pB.vec[4], p1_sub.i = p1_sub.vec[2])
simu3.1.plot.CRM.MBM.diff.Est(dt.combo = Simu3.s1.Nhat, p1_pB.i = pB.vec[4], p1_sub.i = p1_sub.vec[3])
# simu3.1.plot.CRM.MBM.diff.Est(dt.combo = Simu3.s1.Nhat, p1_pB.i = pB.vec[4], p1_sub.i = p1_sub.vec[4])
```


#### Scenario 2 variant - sample 2 is not random
```{r}
# Scenario 1 for CRM
p.X1.vec <- 0.6
pB.vec <- c(0.1, 0.3, 0.6)
# Deflation factor to reflect incomplete sample of the benchmark
p1_sub.vec <- c(0.65, 0.85, 0.95)
p2.X0.vec <- 0 # I call pB here because this benchmark incorrectly used as a sample
p2.X1.vec <- c(0.05, 0.1, 0.3, 0.6)
scenarios2 <- expand.grid(pB_vec = pB.vec, p1_sub_vec = p1_sub.vec, p2.X0_vec = p2.X0.vec, p2.X1_vec = p2.X1.vec, p.X1_vec = p.X1.vec)
scenarios2 <- scenarios2[, c("p.X1_vec","p2.X1_vec","p2.X0_vec","pB_vec","p1_sub_vec")]

# Load functions
source("Simu3.Scenarios.Function.R")

# Run simulation, get summary statistics
Simu3.s2.Nhat <- s3.2.vary_p(simsize = nsim, pplsize = targetN, 
                     pB = scenarios2$pB_vec,  p1_sub = scenarios2$p1_sub_vec, p2.X1 = scenarios2$p2.X1_vec,
                     p2.X0 = scenarios2$p2.X0_vec, p.X1 = scenarios2$p.X1_vec)

# Write into a file
write.csv(Simu3.s2.Nhat, file = "Simu_Output/Simu3/ResultTb/Simu3.s2.Nhat.csv", row.names = FALSE)
```

Plot given each possible p1 and p1_sub, the relative bias as p2 increase.
```{r}
# Load functions
source("Simu3.Scenarios.Function.R")
simu3.2.plot.CRM.MBM.diff.Est(dt.combo = Simu3.s2.Nhat, p1_pB.i = pB.vec[1], p1.sub.i = p1_sub.vec[1])
simu3.2.plot.CRM.MBM.diff.Est(dt.combo = Simu3.s2.Nhat, p1_pB.i = pB.vec[1], p1.sub.i = p1_sub.vec[2])
simu3.2.plot.CRM.MBM.diff.Est(dt.combo = Simu3.s2.Nhat, p1_pB.i = pB.vec[1], p1.sub.i = p1_sub.vec[3])

simu3.2.plot.CRM.MBM.diff.Est(dt.combo = Simu3.s2.Nhat, p1_pB.i = pB.vec[2], p1.sub.i = p1_sub.vec[1])
simu3.2.plot.CRM.MBM.diff.Est(dt.combo = Simu3.s2.Nhat, p1_pB.i = pB.vec[2], p1.sub.i = p1_sub.vec[2])
simu3.2.plot.CRM.MBM.diff.Est(dt.combo = Simu3.s2.Nhat, p1_pB.i = pB.vec[2], p1.sub.i = p1_sub.vec[3])

simu3.2.plot.CRM.MBM.diff.Est(dt.combo = Simu3.s2.Nhat, p1_pB.i = pB.vec[3], p1.sub.i = p1_sub.vec[1])
simu3.2.plot.CRM.MBM.diff.Est(dt.combo = Simu3.s2.Nhat, p1_pB.i = pB.vec[3], p1.sub.i = p1_sub.vec[2])
simu3.2.plot.CRM.MBM.diff.Est(dt.combo = Simu3.s2.Nhat, p1_pB.i = pB.vec[3], p1.sub.i = p1_sub.vec[3])
```


#### Scenario 3 - Link/Not Link samples but dependent
We describe a case where dependence between the data sources. One varying parameter is the dependence level. We consider both negative and positive dependence, it means that if a subject was included in the benchmark(sample 1), he is more likely to be included in sample 2 too.

In this case, we assume both samples are random, but the benchmark is not 100% included.

Varying parameter of dependence level: 
dep.factor <- c(0.6, 0.8, 1.2, 1.4, 1.6)

Such dependence is not impacted by the incompleteness of the benchmark, that is, even though some people were missed by the benchmark, they should still be more likely included into the sample 2 as long as they have the benchmark attribute.


```{r}
# simsize <- nsim
# pplsize <- targetN

# True Benchmark prevalence
pB.vec <-  0.05 # c(0.05, 0.1, 0.3, 0.6)
# Deflation factor to reflect incomplete sample of the benchmark
p1_sub.vec <- c(0.85, 0.9, 0.95)
# Random sample 2
p2.vec <-  c(0.05, 0.1, 0.3, 0.6)
# Dependence factor (a multiplier to p2.vec conditional on being included in the benchmark already)
dep.factor.vec <- c(0.6, 0.8, 1.2, 1.4, 1.6)
# Combine permutation of scenarios
scenarios3 <- expand.grid(p1_sub_vec = p1_sub.vec, p2_vec = p2.vec, pB_vec = pB.vec, dep.factor_vec = dep.factor.vec)
scenarios3 <- scenarios3[, c("pB_vec","p2_vec","p1_sub_vec","dep.factor_vec")]

# Load functions
source("Simu3.Scenarios.Function.R")

# Run simulation, get summary statistics
Simu3.s3.Nhat <- s3.3.vary_p(simsize = nsim, pplsize = targetN, 
                     pB = scenarios3$pB_vec,  p1_sub = scenarios3$p1_sub_vec, p2 = scenarios3$p2_vec,
                     dep.factor = scenarios3$dep.factor_vec)
write.csv(Simu3.s3.Nhat, file = "/Users/jianingwang/Documents/Boston U PhD/___My Dissertation___/Work2_IndirectEst/_ThesisWork1-TwoSampleMBMvsCRM/Work1-Simulation/Simulation Misuse/Simu_Output/Simu3/ResultTb/Simu3.3/Simu3.s3.Nhat.csv", row.names = FALSE)
```

Plot by each possible value of dependence factor. For each level of dependence, we examine the relative bias between estimated N and true N as p2 increase given the same p1(pB) and p1_sub.
```{r}
# Load functions
source("Simu3.Scenarios.Function.R")
# Dependence level 1
# pB [1]
subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[1], p1_sub.i = p1_sub.vec[1], dep.factor.i = dep.factor.vec[1])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[1], p1_sub.i = p1_sub.vec[1], dep.factor.i = dep.factor.vec[1], ErrorBar = "Yes")

subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[1], p1_sub.i = p1_sub.vec[2], dep.factor.i = dep.factor.vec[1])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[1], p1_sub.i = p1_sub.vec[2], dep.factor.i = dep.factor.vec[1], ErrorBar = "Yes")

subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[1], p1_sub.i = p1_sub.vec[3], dep.factor.i = dep.factor.vec[1])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[1], p1_sub.i = p1_sub.vec[3], dep.factor.i = dep.factor.vec[1], ErrorBar = "Yes")

# pB [2]
subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[2], p1_sub.i = p1_sub.vec[1], dep.factor.i = dep.factor.vec[1])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[2], p1_sub.i = p1_sub.vec[1], dep.factor.i = dep.factor.vec[1], ErrorBar = "No")

subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[2], p1_sub.i = p1_sub.vec[2], dep.factor.i = dep.factor.vec[1])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[2], p1_sub.i = p1_sub.vec[2], dep.factor.i = dep.factor.vec[1], ErrorBar = "No")

subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[2], p1_sub.i = p1_sub.vec[3], dep.factor.i = dep.factor.vec[1])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[2], p1_sub.i = p1_sub.vec[3], dep.factor.i = dep.factor.vec[1], ErrorBar = "No")

# pB [3]
subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[3], p1_sub.i = p1_sub.vec[1], dep.factor.i = dep.factor.vec[1])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[3], p1_sub.i = p1_sub.vec[1], dep.factor.i = dep.factor.vec[1], ErrorBar = "No")

subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[3], p1_sub.i = p1_sub.vec[2], dep.factor.i = dep.factor.vec[1])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[3], p1_sub.i = p1_sub.vec[2], dep.factor.i = dep.factor.vec[1], ErrorBar = "No")

subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[3], p1_sub.i = p1_sub.vec[3], dep.factor.i = dep.factor.vec[1])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[3], p1_sub.i = p1_sub.vec[3], dep.factor.i = dep.factor.vec[1], ErrorBar = "No")

# pB [4]
subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[4], p1_sub.i = p1_sub.vec[1], dep.factor.i = dep.factor.vec[1])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[4], p1_sub.i = p1_sub.vec[1], dep.factor.i = dep.factor.vec[1], ErrorBar = "No")

subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[4], p1_sub.i = p1_sub.vec[2], dep.factor.i = dep.factor.vec[1])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[4], p1_sub.i = p1_sub.vec[2], dep.factor.i = dep.factor.vec[1], ErrorBar = "No")

subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[4], p1_sub.i = p1_sub.vec[3], dep.factor.i = dep.factor.vec[1])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[4], p1_sub.i = p1_sub.vec[3], dep.factor.i = dep.factor.vec[1], ErrorBar = "No")

# Dependence level 2
# pB [1]
subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[1], p1_sub.i = p1_sub.vec[1], dep.factor.i = dep.factor.vec[2])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[1], p1_sub.i = p1_sub.vec[1], dep.factor.i = dep.factor.vec[2], ErrorBar = "No")

subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[1], p1_sub.i = p1_sub.vec[2], dep.factor.i = dep.factor.vec[2])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[1], p1_sub.i = p1_sub.vec[2], dep.factor.i = dep.factor.vec[2], ErrorBar = "No")

subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[1], p1_sub.i = p1_sub.vec[3], dep.factor.i = dep.factor.vec[2])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[1], p1_sub.i = p1_sub.vec[3], dep.factor.i = dep.factor.vec[2], ErrorBar = "No")

# pB [2]
subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[2], p1_sub.i = p1_sub.vec[1], dep.factor.i = dep.factor.vec[2])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[2], p1_sub.i = p1_sub.vec[1], dep.factor.i = dep.factor.vec[2], ErrorBar = "No")

subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[2], p1_sub.i = p1_sub.vec[2], dep.factor.i = dep.factor.vec[2])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[2], p1_sub.i = p1_sub.vec[2], dep.factor.i = dep.factor.vec[2], ErrorBar = "No")

subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[2], p1_sub.i = p1_sub.vec[3], dep.factor.i = dep.factor.vec[2])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[2], p1_sub.i = p1_sub.vec[3], dep.factor.i = dep.factor.vec[2], ErrorBar = "No")

# pB [3]
subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[3], p1_sub.i = p1_sub.vec[1], dep.factor.i = dep.factor.vec[2])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[3], p1_sub.i = p1_sub.vec[1], dep.factor.i = dep.factor.vec[2], ErrorBar = "No")

subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[3], p1_sub.i = p1_sub.vec[2], dep.factor.i = dep.factor.vec[2])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[3], p1_sub.i = p1_sub.vec[2], dep.factor.i = dep.factor.vec[2], ErrorBar = "No")

subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[3], p1_sub.i = p1_sub.vec[3], dep.factor.i = dep.factor.vec[2])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[3], p1_sub.i = p1_sub.vec[3], dep.factor.i = dep.factor.vec[2], ErrorBar = "No")

# pB [4]
subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[4], p1_sub.i = p1_sub.vec[1], dep.factor.i = dep.factor.vec[2])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[4], p1_sub.i = p1_sub.vec[1], dep.factor.i = dep.factor.vec[2], ErrorBar = "No")

subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[4], p1_sub.i = p1_sub.vec[2], dep.factor.i = dep.factor.vec[2])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[4], p1_sub.i = p1_sub.vec[2], dep.factor.i = dep.factor.vec[2], ErrorBar = "No")

subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[4], p1_sub.i = p1_sub.vec[3], dep.factor.i = dep.factor.vec[2])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[4], p1_sub.i = p1_sub.vec[3], dep.factor.i = dep.factor.vec[2], ErrorBar = "No")

source("Simu3.Scenarios.Function.R")
# Dependence level 3
# pB [1]
subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[1], p1_sub.i = p1_sub.vec[1], dep.factor.i = dep.factor.vec[3])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[1], p1_sub.i = p1_sub.vec[1], dep.factor.i = dep.factor.vec[3], ErrorBar = "Yes")

subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[1], p1_sub.i = p1_sub.vec[2], dep.factor.i = dep.factor.vec[3])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[1], p1_sub.i = p1_sub.vec[2], dep.factor.i = dep.factor.vec[3], ErrorBar = "Yes")

subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[1], p1_sub.i = p1_sub.vec[3], dep.factor.i = dep.factor.vec[3])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[1], p1_sub.i = p1_sub.vec[3], dep.factor.i = dep.factor.vec[3], ErrorBar = "Yes")

# pB [2]
subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[2], p1_sub.i = p1_sub.vec[1], dep.factor.i = dep.factor.vec[3])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[2], p1_sub.i = p1_sub.vec[1], dep.factor.i = dep.factor.vec[3], ErrorBar = "Yes")

subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[2], p1_sub.i = p1_sub.vec[2], dep.factor.i = dep.factor.vec[3])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[2], p1_sub.i = p1_sub.vec[2], dep.factor.i = dep.factor.vec[3], ErrorBar = "Yes")

subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[2], p1_sub.i = p1_sub.vec[3], dep.factor.i = dep.factor.vec[3])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[2], p1_sub.i = p1_sub.vec[3], dep.factor.i = dep.factor.vec[3], ErrorBar = "Yes")

# pB [3]
subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[3], p1_sub.i = p1_sub.vec[1], dep.factor.i = dep.factor.vec[3])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[3], p1_sub.i = p1_sub.vec[1], dep.factor.i = dep.factor.vec[3], ErrorBar = "Yes")

subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[3], p1_sub.i = p1_sub.vec[2], dep.factor.i = dep.factor.vec[3])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[3], p1_sub.i = p1_sub.vec[2], dep.factor.i = dep.factor.vec[3], ErrorBar = "Yes")

subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[3], p1_sub.i = p1_sub.vec[3], dep.factor.i = dep.factor.vec[3])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[3], p1_sub.i = p1_sub.vec[3], dep.factor.i = dep.factor.vec[3], ErrorBar = "Yes")

# pB [4]
subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[4], p1_sub.i = p1_sub.vec[1], dep.factor.i = dep.factor.vec[3])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[4], p1_sub.i = p1_sub.vec[1], dep.factor.i = dep.factor.vec[3], ErrorBar = "Yes")

subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[4], p1_sub.i = p1_sub.vec[2], dep.factor.i = dep.factor.vec[3])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[4], p1_sub.i = p1_sub.vec[2], dep.factor.i = dep.factor.vec[3], ErrorBar = "Yes")

subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[4], p1_sub.i = p1_sub.vec[3], dep.factor.i = dep.factor.vec[3])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[4], p1_sub.i = p1_sub.vec[3], dep.factor.i = dep.factor.vec[3], ErrorBar = "Yes")

# Dependence level 4
# pB [1]
subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[1], p1_sub.i = p1_sub.vec[1], dep.factor.i = dep.factor.vec[4])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[1], p1_sub.i = p1_sub.vec[1], dep.factor.i = dep.factor.vec[4], ErrorBar = "Yes")

subdt1 <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[1], p1_sub.i = p1_sub.vec[2], dep.factor.i = dep.factor.vec[4])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[1], p1_sub.i = p1_sub.vec[2], dep.factor.i = dep.factor.vec[4], ErrorBar = "Yes")

subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[1], p1_sub.i = p1_sub.vec[3], dep.factor.i = dep.factor.vec[4])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[1], p1_sub.i = p1_sub.vec[3], dep.factor.i = dep.factor.vec[4], ErrorBar = "Yes")

# pB [2]
subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[2], p1_sub.i = p1_sub.vec[1], dep.factor.i = dep.factor.vec[4])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[2], p1_sub.i = p1_sub.vec[1], dep.factor.i = dep.factor.vec[4], ErrorBar = "Yes")

subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[2], p1_sub.i = p1_sub.vec[2], dep.factor.i = dep.factor.vec[4])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[2], p1_sub.i = p1_sub.vec[2], dep.factor.i = dep.factor.vec[4], ErrorBar = "Yes")

subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[2], p1_sub.i = p1_sub.vec[3], dep.factor.i = dep.factor.vec[4])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[2], p1_sub.i = p1_sub.vec[3], dep.factor.i = dep.factor.vec[4], ErrorBar = "Yes")

# pB [3]
subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[3], p1_sub.i = p1_sub.vec[1], dep.factor.i = dep.factor.vec[4])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[3], p1_sub.i = p1_sub.vec[1], dep.factor.i = dep.factor.vec[4], ErrorBar = "Yes")

subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[3], p1_sub.i = p1_sub.vec[2], dep.factor.i = dep.factor.vec[4])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[3], p1_sub.i = p1_sub.vec[2], dep.factor.i = dep.factor.vec[4], ErrorBar = "Yes")

subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[3], p1_sub.i = p1_sub.vec[3], dep.factor.i = dep.factor.vec[4])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[3], p1_sub.i = p1_sub.vec[3], dep.factor.i = dep.factor.vec[4], ErrorBar = "Yes")

# pB [4]
subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[4], p1_sub.i = p1_sub.vec[1], dep.factor.i = dep.factor.vec[4])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[4], p1_sub.i = p1_sub.vec[1], dep.factor.i = dep.factor.vec[4], ErrorBar = "Yes")

subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[4], p1_sub.i = p1_sub.vec[2], dep.factor.i = dep.factor.vec[4])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[4], p1_sub.i = p1_sub.vec[2], dep.factor.i = dep.factor.vec[4], ErrorBar = "Yes")

subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[4], p1_sub.i = p1_sub.vec[3], dep.factor.i = dep.factor.vec[4])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[4], p1_sub.i = p1_sub.vec[3], dep.factor.i = dep.factor.vec[4], ErrorBar = "Yes")

# Dependence level 5
# pB [1]
subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[1], p1_sub.i = p1_sub.vec[1], dep.factor.i = dep.factor.vec[5])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[1], p1_sub.i = p1_sub.vec[1], dep.factor.i = dep.factor.vec[5], ErrorBar = "Yes")

subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[1], p1_sub.i = p1_sub.vec[2], dep.factor.i = dep.factor.vec[5])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[1], p1_sub.i = p1_sub.vec[2], dep.factor.i = dep.factor.vec[5], ErrorBar = "Yes")

subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[1], p1_sub.i = p1_sub.vec[3], dep.factor.i = dep.factor.vec[5])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[1], p1_sub.i = p1_sub.vec[3], dep.factor.i = dep.factor.vec[5], ErrorBar = "Yes")

# pB [2]
subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[2], p1_sub.i = p1_sub.vec[1], dep.factor.i = dep.factor.vec[5])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[2], p1_sub.i = p1_sub.vec[1], dep.factor.i = dep.factor.vec[5], ErrorBar = "Yes")

subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[2], p1_sub.i = p1_sub.vec[2], dep.factor.i = dep.factor.vec[5])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[2], p1_sub.i = p1_sub.vec[2], dep.factor.i = dep.factor.vec[5], ErrorBar = "Yes")

subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[2], p1_sub.i = p1_sub.vec[3], dep.factor.i = dep.factor.vec[5])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[2], p1_sub.i = p1_sub.vec[3], dep.factor.i = dep.factor.vec[5], ErrorBar = "Yes")

# pB [3]
subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[3], p1_sub.i = p1_sub.vec[1], dep.factor.i = dep.factor.vec[5])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[3], p1_sub.i = p1_sub.vec[1], dep.factor.i = dep.factor.vec[5], ErrorBar = "Yes")

subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[3], p1_sub.i = p1_sub.vec[2], dep.factor.i = dep.factor.vec[5])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[3], p1_sub.i = p1_sub.vec[2], dep.factor.i = dep.factor.vec[5], ErrorBar = "Yes")

subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[3], p1_sub.i = p1_sub.vec[3], dep.factor.i = dep.factor.vec[5])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[3], p1_sub.i = p1_sub.vec[3], dep.factor.i = dep.factor.vec[5], ErrorBar = "Yes")

# pB [4]
subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[4], p1_sub.i = p1_sub.vec[1], dep.factor.i = dep.factor.vec[5])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[4], p1_sub.i = p1_sub.vec[1], dep.factor.i = dep.factor.vec[5], ErrorBar = "Yes")

subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[4], p1_sub.i = p1_sub.vec[2], dep.factor.i = dep.factor.vec[5])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[4], p1_sub.i = p1_sub.vec[2], dep.factor.i = dep.factor.vec[5], ErrorBar = "Yes")

subdt <- simu3.3.Dt.CRM.MBM.diff.Est(dt.combo = Simu3.s3.Nhat, p1_pB.i = pB.vec[4], p1_sub.i = p1_sub.vec[3], dep.factor.i = dep.factor.vec[5])
simu3.3.plot.CRM.MBM.diff.Est(dt.combo = subdt, p1_pB.i = pB.vec[4], p1_sub.i = p1_sub.vec[3], dep.factor.i = dep.factor.vec[5], ErrorBar = "Yes")
```



























--------------- Archived 11/29/2021 --------------- 
Plot out
```{r}
# If import and plot
# s2.Nhat.sub <- read.csv("Simu_Output/s2.Nhat_sub.csv")

# CRM
# Clean up data
s2.Nhat.sub <- subset(s2.Nhat, select = c(p2, pB, p1_sub, Mean.Nhat_CRM, SD.Nhat_CRM))
s2.Nhat.sub$p_1_data <- as.factor(s2.Nhat.sub$pB*s2.Nhat.sub$p1_sub)
s2.Nhat.sub$pB <- as.factor(s2.Nhat.sub$pB)
s2.Nhat.sub$p2 <- as.factor(s2.Nhat.sub$p2)
s2.Nhat.sub$p_1_data <- as.factor(s2.Nhat.sub$p_1_data)

# Plot (CRM)
plot.title <- paste("Incompleteness level =", unique(s2.Nhat.sub$p1_sub), "(Sample 2 is random)", sep = " ")
ggplot(s2.Nhat.sub, aes(x = p2, y = Mean.Nhat_CRM, color = pB)) +
  geom_point() + 
  geom_hline(yintercept = 5000, linetype = "dashed", color = "red") +
  ggtitle(plot.title) + 
  theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 14),
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 14))      
plot.title <- paste("Incompleteness level =", unique(s2.Nhat.sub$p1_sub), "(Sample 2 is random)", sep = " ")
ggplot(s2.Nhat.sub, aes(x = pB, y = Mean.Nhat_CRM, color = p2)) +
  geom_point() + 
  geom_hline(yintercept = 5000, linetype = "dashed", color = "red") +
  ggtitle(plot.title) + 
  theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 14),
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 14))   
# MBM-linked
# Clean up data
s2.Nhat.sub <- subset(s2.Nhat, select = c(p2, pB, p1_sub, Mean.Nhat_MBM_link, SD.Nhat_CRM))
s2.Nhat.sub$p_1_data <- as.factor(s2.Nhat.sub$pB*s2.Nhat.sub$p1_sub)
s2.Nhat.sub$pB <- as.factor(s2.Nhat.sub$pB)
s2.Nhat.sub$p2 <- as.factor(s2.Nhat.sub$p2)
s2.Nhat.sub$p_1_data <- as.factor(s2.Nhat.sub$p_1_data)

# Plot
plot.title <- paste("Incompleteness level =", unique(s2.Nhat.sub$p1_sub), "(Sample 2 is random)", sep = " ")
ggplot(s2.Nhat.sub, aes(x = p2, y = Mean.Nhat_MBM_link, color = pB)) +
  geom_point() + 
  geom_hline(yintercept = 5000, linetype = "dashed", color = "red") +
  ggtitle(plot.title) + 
  theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 14),
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 14))     

```

Correction the missing issue
```{r}
# # try to mimic what supposed to be after the correction (seed = 7777)
# s1.Nhat.sub <- subset(s1.Nhat, select = c(p2, pB, Mean.Nhat_CRM, SD.Nhat_CRM))
# # s1.Nhat.sub$actual_p1 <- as.factor(s1.Nhat.sub$pB)
# s1.Nhat.sub$p2 <- as.factor(s1.Nhat.sub$p2)
# s1.Nhat.sub$pB <- as.factor(s1.Nhat.sub$pB)
# 
# ggplot(s1.Nhat.sub, aes(x = p2, y = Mean.Nhat_CRM, color = pB)) +
#   geom_point() + 
#   geom_hline(yintercept=5000, linetype="dashed", color = "red") +
#   ggtitle("Scenario 2(s2): Adjust for the incompleteness in Benchmark") + 
#   theme(axis.text = element_text(size = 14),
#         axis.title = element_text(size = 14),
#         legend.text = element_text(size = 14),
#         legend.title = element_text(size = 14)) 
# ggplot(s1.Nhat.sub, aes(x = pB, y = Mean.Nhat_CRM, color = p2)) +
#   geom_point() + 
#   geom_hline(yintercept=5000, linetype="dashed", color = "red") +
#   ggtitle("Scenario 2(s2): Adjust for the incompleteness in Benchmark") + 
#   theme(axis.text = element_text(size = 14),
#         axis.title = element_text(size = 14),
#         legend.text = element_text(size = 14),
#         legend.title = element_text(size = 14)) 



```














----------- Not run ----------- 
#### Scenario 3 - Link/Not link samples in MBM and Incomplete Benchmark and biased multiplier (to correct incompleteness issue in Benchmark)

From scenario 2, we identified that if sample 1 is meant to collect Benchmark, but incompleteness happens, such that Benchmark members have p_sub (p_sub = P(sample 1|Benchmark)) chance to enter, non-Benchmark members have 0 chance to enter. 

If a source for multiplier estimation could capture this under-counting issue, it results in a biased source w.r.t the underlying target population, but the hypothesis is that it would reduce the bias in the estimates.

Simulation setup:
Step 1: pB select sub-population from entire population (Underlying)
Step 2: p1 < pB, the selection is if(sub-population) then assign p = p1_sub to select, if(! sub-population) then 0% select, get sample 1 (data at hands)
Step 3: 

```{r}
# simsize <- nsim
# pplsize <- targetN

# True Benchmark prevalence
pB.vec <- seq(0.1, 0.7, by = 0.1)
# Deflation factor to reflect incomplete sample of the benchmark
p1_sub.vec <- seq(0.65,0.95, by = 0.1) 
# Random sample 2
p2.vec <- seq(0.1, 0.7, by = 0.1)
# Combine permutation of scenarios
scenarios3 <- expand.grid(p1_sub_vec = p1_sub.vec[1], p2_vec = p2.vec, pB_vec = pB.vec)
scenarios3 <- scenarios3[, c("pB_vec","p2_vec","p1_sub_vec")]

# Load functions
source("Simu3.Scenarios.Function.R")

# Run simulation, get summary statistics
s3.Nhat <- s2.vary_p(simsize = nsim, pplsize = targetN, 
                     pB = scenarios3$pB_vec,  p1_sub = scenarios3$p1_sub_vec, p2 = scenarios3$p2_vec)

```



Plot out
```{r}
# If import and plot
# s3.Nhat.sub <- read.csv("Simu_Output/s3.Nhat_sub.csv")

# CRM
# Clean up data
s3.Nhat.sub <- subset(s3.Nhat, select = c(p2, pB, p1_sub, Mean.Nhat_CRM, SD.Nhat_CRM))
s3.Nhat.sub$p_1_data <- as.factor(s3.Nhat.sub$pB*s3.Nhat.sub$p1_sub)
s3.Nhat.sub$pB <- as.factor(s3.Nhat.sub$pB)
s3.Nhat.sub$p2 <- as.factor(s3.Nhat.sub$p2)
s3.Nhat.sub$p_1_data <- as.factor(s3.Nhat.sub$p_1_data)

# Plot (CRM)
plot.title <- paste("Incompleteness level =", unique(s3.Nhat.sub$p1_sub), "(Sample 2 is random)", sep = " ")
ggplot(s3.Nhat.sub, aes(x = p2, y = Mean.Nhat_CRM, color = pB)) +
  geom_point() + 
  geom_hline(yintercept = 5000, linetype = "dashed", color = "red") +
  ggtitle(plot.title) + 
  theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 14),
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 14))      

# MBM-linked
# Clean up data
s3.Nhat.sub <- subset(s3.Nhat, select = c(p2, pB, p1_sub, Mean.Nhat_MBM_link, SD.Nhat_CRM))
s3.Nhat.sub$p_1_data <- as.factor(s3.Nhat.sub$pB*s3.Nhat.sub$p1_sub)
s3.Nhat.sub$pB <- as.factor(s3.Nhat.sub$pB)
s3.Nhat.sub$p2 <- as.factor(s3.Nhat.sub$p2)
s3.Nhat.sub$p_1_data <- as.factor(s3.Nhat.sub$p_1_data)

# Plot
plot.title <- paste("Incompleteness level =", unique(s3.Nhat.sub$p1_sub), "(Sample 2 is random)", sep = " ")
ggplot(s3.Nhat.sub, aes(x = p2, y = Mean.Nhat_MBM_link, color = pB)) +
  geom_point() + 
  geom_hline(yintercept = 5000, linetype = "dashed", color = "red") +
  ggtitle(plot.title) + 
  theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 14),
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 14))     

```


#### Scenario 4 - Not linked samples in MBM and compete Benchmark and biased multiplier

1. Two samples are not linked in MBM; CRM assumes linkage
2. You know Benchmark size
3. You have a sample (sample1) completely capture Benchmark people and want to take it as the benchmark
4. Another sample (sample2) is a positively biased (relative to sample1) sample of entire population 

In CRM, you just have two samples, sample1 and sample2 (positively biased towards sample 1, i.e. dependent to sample1); Also could see as linked MBM, the overlap is automatically changed
In MBM assuming no linkage, you know and use true Benchmark size, you take sample2 as source for getting multiplier, however, it is biased - more or less inclusion given ID is in sample1.

Step 1: pB select sub-population from entire population (Underlying)
Step 2: p1 = pB, the selection is if(sub-population) then 100% select, if(! sub-population) then 0% select, get sample 1 (data at hands)
Step 3: ("p2_sample1" = p2|sample1) > ("p2_else" = p2|!sample1), more likely to be in sample2 if ID is already in sample1 (interpret: in CRM, positive dependence). We denote p2_sample1 = c * p2_else

```{r}
# simsize <- nsim
# pplsize <- targetN

# True Benchmark prevalence
pB.vec <- seq(0.1, 0.5, by = 0.2)
p1.vec <- pB.vec
# Define positive dependent sample 2 w.r.t sample 1
p2_else_vec <- seq(0.05, 0.5, by = 0.15) # w.r.t the rest of target ppl
c <- 1.5 # inflation factor
p2_sample1_vec <- c * p2_else_vec # w.r.t the drawn from sample 1
# Combine permutation of scenarios
scenarios4 <- as.data.frame(cbind(pB_vec = rep(pB.vec, each = length(p2_sample1_vec)), p2_sample1_vec, p2_else_vec))
scenarios4 <- scenarios4[, c("pB_vec","p2_sample1_vec","p2_else_vec")]


s4.single_p <- function(simsize = nsim, pplsize = targetN, 
                        pB = scenarios4$pB_vec[1], p2_sample1 = scenarios4$p2_sample1_vec[1], p2_else = scenarios4$p2_else_vec[1] ){
  # Create datasets
  benchmark <- matrix(0, nrow = simsize, ncol = pplsize)
  sample1.dt <- matrix(0, nrow = simsize, ncol = pplsize)
  sample2.dt <- matrix(0, nrow = simsize, ncol = pplsize)
  # Simulate for each element
  for (i in 1:simsize){
  set.seed(1234+i)
  # Draw individuals for Benchmark
  benchmark[i,] <- rbinom(pplsize, 1, pB)
  # All benchmark people got sampled into the sample 1 for CRM and MBM
  sample1.dt[i,which(benchmark[i,] == 1)] <- 1
  # Compute n in sample 1
  n_1 <- sum(sample1.dt[i,] == 1)
  n_0 <- sum(sample1.dt[i,] == 0)
  # Draw individuals for source 2 for CRM or MBM to generate proportion
  sample2.dt[i,which(sample1.dt[i,] == 1)] <- rbinom(n_1, 1, p2_sample1)
  sample2.dt[i,which(sample1.dt[i,] == 0)] <- rbinom(n_0, 1, p2_else)
  }
  # Got two data sample, sample1.dt and sample2.dt
  # Marginal counts for sources
  n1 <- apply(sample1.dt,1,sum)
  n2 <- apply(sample2.dt,1,sum)
  # Overlapping individuals, equivalent to labeling the overlapping
  sample1.2.dt<-sample1.dt*sample2.dt
  
  ####################
  # --- Estimate --- #
  ####################
  # /// CRM /// #
  # Counts of overlapping
  n11 <- apply(sample1.2.dt,1,sum)
  # LP estimator 
  Nhat_CRM <- n1*n2/n11
  # Summary
  avg_n11_CRM <- mean(n11)
  avg_n1_CRM <- mean(n1)
  avg_n2_CRM <- mean(n2)
  # Statistics
  MSE.Nhat_CRM <- mean((Nhat_CRM-pplsize)^2)
  Mean.Nhat_CRM <- mean(Nhat_CRM)
  SD.Nhat_CRM <- sd(Nhat_CRM)
  LB95.Nhat_CRM <- mean(Nhat_CRM) - 1.96*sd(Nhat_CRM)
  UB95.Nhat_CRM <- mean(Nhat_CRM) + 1.96*sd(Nhat_CRM)
  # /// MBM - (Linked) /// #
  p_m_linked_MBM <- n11/n2
  # Summary
  avg_multiplier_linked_MBM <- mean(p_m_linked_MBM)
  
  
  # !!! Unlinked has issues! !!! # 
  # /// MBM - (Unlinked) True Benchmark size divided by biased multiplier /// #
  # Compute N via MBM 
  n_B <- pplsize * pB
  # Find correct number of overlapping
  sample.b.2.dt <- matrix(0, nrow = simsize, ncol = pplsize)
  prop.be.B.in.sample2 <- p2_sample1/(p2_sample1+p2_else)
  for(i in 1:simsize){
    sample.b.2.dt[i,which(sample2.dt[i,] == 1)] <- rbinom(n2[i], 1, prop.be.B.in.sample2)  
  }
  nB2 <- apply(sample.b.2.dt,1,sum)
  # Get multiplier estimate
  p_m <- nB2/n2
  # MBM estimate: True size of Benchmark divided by biased multiplier
  Nhat_MBM <- n_B/p_m
  # Summary
  avg_multiplier_unlinked_MBM <- mean(p_m)
  avg_nB2_MBM <- mean(nB2)
  avg_n1_MBM <- mean(n1)
  avg_n2_MBM <- mean(n2)
  # Statistics
  MSE.Nhat_MBM <- mean((Nhat_MBM-pplsize)^2)
  Mean.Nhat_MBM <- mean(Nhat_MBM)
  SD.Nhat_MBM <- sd(Nhat_MBM)
  LB95.Nhat_MBM <- mean(Nhat_MBM) - 1.96*sd(Nhat_MBM)
  UB95.Nhat_MBM <- mean(Nhat_MBM) + 1.96*sd(Nhat_MBM)
  # Combine both estimates
  df <- data.frame(# CRM
                   avg_n11_CRM, avg_n1_CRM, avg_n2_CRM, avg_multiplier_linked_MBM,
                   MSE.Nhat_CRM, Mean.Nhat_CRM, SD.Nhat_CRM, LB95.Nhat_CRM, UB95.Nhat_CRM
                   # , 
                   # MBM
                   # avg_multiplier_unlinked_MBM,avg_nB2_MBM, avg_n1_MBM, avg_n2_MBM, 
                   # MSE.Nhat_MBM, Mean.Nhat_MBM, SD.Nhat_MBM, LB95.Nhat_MBM, UB95.Nhat_MBM
                   )
  df <- round(df, digits = 3)
  return(df)
}

s4.vary_p <- function(simsize = nsim, pplsize = targetN, n.scenario = nrow(scenarios4), 
                      pB = scenarios4$pB_vec, p2_sample1 = scenarios4$p2_sample1_vec, p2_else = scenarios4$p2_else_vec ){
  # Start changing scenarios4 across the vector of pre-specified p
  # Create list, each element is one sub-scenario 
  s4.ls <- list()
  # Put in list (Dim = length(p.vex) with each element has dim = simsize * pplsize)
  length.ls <- n.scenario
  for(l in 1:length.ls){
    s4.ls[[l]] <-  s4.single_p(simsize = simsize, pplsize = pplsize, 
                               pB = pB[l],  p2_sample1 = p2_sample1[l], p2_else = p2_else[l])
  }
  # Collapse the list
  s4.comb <- do.call(rbind,s4.ls)
  # Add scenarios4
  scenario <- data.frame(pB, p2_sample1, p2_else)
  # Final output
  final.s4.comb <- as.data.frame(cbind(scenario,s4.comb))
  return(final.s4.comb)
}
# Run simulation, get summary statistics
s4.Nhat <- s4.vary_p(simsize = nsim, pplsize = targetN, 
                     pB = scenarios4$pB_vec, p2_sample1 = scenarios4$p2_sample1_vec, p2_else = scenarios4$p2_else_vec)
write.csv(s4.Nhat, file = "Simu_Output/s4.Nhat.csv", row.names = FALSE)
```

